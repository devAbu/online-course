var aws=require("aws-sdk"),base64=require("js-base64").Base64,createQueue=require("queue-async"),backoff=require("backoff"),es=require("event-stream"),crypto=require("crypto"),xtend=require("xtend"),mime=require("mime"),once=require("once"),knox=require("knox-s3"),url=require("url"),fs=require("fs"),utils=require("../utils"),LAMBDA_ROLE_UE1="arn:aws:iam::979120195943:role/aws-nodejs-dev-us-east-1-lambdaRole",DEFAULT_REGION="us-east-1",lambdaClient=function(e){var n=e.split("::");return new aws.Lambda({region:DEFAULT_REGION,accessKeyId:n[0],secretAccessKey:n[1]})},cloudWatchLogsClient=function(e){var n=e.split("::");return new aws.CloudWatchLogs({region:DEFAULT_REGION,accessKeyId:n[0],secretAccessKey:n[1]})};module.exports={deployConfig:function(e){return new Promise(function(n,t){e.nonce="aefawefaw",utils.postRequest("https://platform.turbo360-vector.com/deploy",e).then(function(e){if("success"!=e.confirmation)return console.log("ERROR 1: "+JSON.stringify(e)),void t(new Error(e.message));var r=base64.decode(e.aws).split("aefawefaw");e.deploy=r.join("::"),n(e)}).catch(function(e){t(e)})})},deleteObject:function(e,n){return new Promise(function(t,r){var o=n.split("::");aws.config.update({accessKeyId:o[0],secretAccessKey:o[1]});var i=new aws.S3;i.listObjects({Bucket:e.Bucket,Prefix:e.Key+"/"},function(n,o){if(n)return void r(n);if(0==o.Contents.length)return void t(null);var a={Bucket:e.Bucket,Delete:{Objects:[]}};o.Contents.forEach(function(e){a.Delete.Objects.push({Key:e.Key})}),i.deleteObjects(a,function(e,n){if(e)return void r(e);t(n)})})})},invalidateCache:function(e,n){return new Promise(function(t,r){var o={DistributionId:e,InvalidationBatch:{CallerReference:Date.now().toString(),Paths:{Quantity:1,Items:["/"+n+"/*"]}}};(new aws.CloudFront).createInvalidation(o,function(e,n){if(e)return void t();t(n)})})},s3sync:function(e,n){function t(t,o){function i(e){c.headFile(s,function(o,i){return o?e(o):n.force||404===i.statusCode||i.headers["x-amz-meta-syncfilehash"]!==t.md5?r(t,e):i.statusCode>=300?e(new Error("Bad status code: "+i.statusCode)):e(null,t)})}var u=t.fullPath,s=m+("/"===t.path.charAt(0)?t.path.slice(1):t.path);s=s.replace(/\\/g,"/");var f=d+"://"+l+".amazonaws.com/"+n.bucket+"/"+s;a(u,f,function(n,r){if(n)return o(n);if(t.md5=r,t.url=f,t.fresh=!1,t.cached=!1,!e)return i(o);var a="md5:"+h(t);e.get(a,function(n,c){if(!n&&c===r)return t.cached=!0,o(null,t);i(function(n){if(n)return o(n);e.put(a,r,o)})})})}function r(e,t){var r,o=e.fullPath,i=m+e.path,a=backoff.fibonacci({initialDelay:1e3});i=i.replace(/\\/g,"/"),e.fresh=!0,a.failAfter(n.retries),a.on("fail",function(){t(r||new Error("unknown error"))}).on("ready",function(){var u=xtend({"x-amz-acl":n.acl,"x-amz-meta-syncfilehash":e.md5,"Content-Type":mime.lookup(o)},n.headers);c.putFile(o,i,u,function(n,o){if(!n){if(o.statusCode<300)return t(null,e);n=new Error("Bad status code: "+o.statusCode)}r=n,p.emit("fail",n),a.backoff()})}).backoff()}function o(e){e=once(e),c.getFile(n.cacheDest,function(n,t){return n?e(n):404===t.statusCode?e(null):void es.pipeline(t,es.split(),es.parse(),null).once("close",e).once("error",e)})}function i(t){t=once(t),e.createReadStream().pipe(es.stringify()).pipe(fs.createWriteStream(n.cacheSrc)).once("error",t).once("close",function(){c.putFile(n.cacheSrc,n.cacheDest,function(e){if(e)return t(e);fs.unlink(n.cacheSrc,t)})})}function a(e,t,r){var o=crypto.createHash("md5"),i=!1;o.update(JSON.stringify([n.headers,t])),fs.createReadStream(e).on("data",function(e){o.update(e)}).once("error",function(e){i||r(e),i=!0}).once("close",function(){i||r(null,o.digest("hex")),i=!0})}n||(n=e||{},e=!1),n.concurrency=n.concurrency||16,n.headers=n.headers||{},n.cacheSrc=n.cacheSrc||__dirname+"/.sync",n.cacheDest=n.cacheDest||"/.sync",n.retries=n.retries||7,n.acl=n.acl||"public-read",n.force=!!n.force;var c=knox.createClient(n),u=createQueue(n.concurrency),s="us-standard"!==n.region&&n.region,f=n.secure||!("secure"in n),l=s?"s3-"+s:"s3",d=f?"https":"http",m=n.prefix||"",h=n.hashKey||function(e){return e.fullPath},p=es.map(function(e,n){u.defer(function(e,r){e.fullPath=e.fullPath||e.src,e.path=e.path||e.dest,t(e,function(t){return t?n(t):r(),n(null,e)})},e)});return p.getCache=o,p.putCache=i,p},deployFunction:function(e){return new Promise(function(n,t){var r={node:"nodejs8.10",python:"python3.6",python3:"python3.6",python2:"python2.7"},o=lambdaClient(e.config),i="nodejs8.10";e.runtime&&(i=r[e.runtime]||"nodejs8.10");var a=e.handler||"handler.main",c=e.env||{},u={Code:{S3Bucket:"turbo360-functions",S3Key:e.path},Environment:{Variables:c},FunctionName:e.name,Role:LAMBDA_ROLE_UE1,Runtime:i,Handler:a,Description:"This is a Turbo CLI Test",MemorySize:1024,Publish:!0,Timeout:60};o.createFunction(u,function(e,r){if(e)return void n(e);t(r)})})},deployVertex:function(e){return new Promise(function(n,t){var r=lambdaClient(e.config),o=e.role||LAMBDA_ROLE_UE1,i=e.bucket||"turbo360-vertex",a=e.env||{},c={Code:{S3Bucket:i,S3Key:e.path},Environment:{Variables:a},FunctionName:e.name,Role:o,Runtime:"nodejs8.10",Handler:"www/bin.main",Description:"This is a Turbo 360 Vertex",MemorySize:1024,Publish:!0,Timeout:60};r.createFunction(c,function(e,r){if(e)return void t(e);n(r)})})},getFunction:function(e){return new Promise(function(n,t){var r=lambdaClient(e.config),o={FunctionName:e.name};r.getFunction(o,function(e,t){if(e)return void n(null);n(t)})})},deleteFunction:function(e){return new Promise(function(n,t){var r=lambdaClient(e.config),o={FunctionName:e.name};r.deleteFunction(o,function(e,r){if(e)return void t(e);n(r)})})},invokeFunction:function(e){return new Promise(function(n,t){var r=lambdaClient(e),o={FunctionName:e.name,InvocationType:"RequestResponse"};r.invoke(o,function(e,r){if(e)return void t(e);var o=r.Payload;if(o){var i=JSON.parse(o),a={status:i.statusCode,body:JSON.parse(i.body)};return console.log("Function Payload: "+JSON.stringify(a)),void n(i)}console.log("Invoke Function ERROR: "+JSON.stringify(r)),n(r)})})},functionLogs:function(e){return new Promise(function(n,t){var r=cloudWatchLogsClient(e.config),o="/aws/lambda/"+e.name,i={logGroupName:o,limit:250};r.filterLogEvents(i,function(e,r){if(e)return void t(e);var o=r.events;if(null==o)return void t(new Error("No log events found."));var i="\n",a=new RegExp("\t","g");o.forEach(function(e){if(null!=e.message){var n=e.message;"20"===n.substring(0,2)&&(n=n.replace(a," "),i+=n)}}),n(i)})})},functionSummary:function(e){return new Promise(function(n,t){var r={FunctionName:e};new aws.Lambda({region:"us-east-1"}).getFunctionConfiguration(r,function(e,r){if(e)return void t(e);n(r)})})}};